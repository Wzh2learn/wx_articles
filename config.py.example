"""
===============================================================================
                    ‚öôÔ∏è Áªü‰∏ÄÈÖçÁΩÆÊñá‰ª∂Á§∫‰æã (config.py.example)
===============================================================================
Â§çÂà∂‰∏∫ config.py Âπ∂Â°´ÂÖ•‰Ω†ÁöÑÂØÜÈí•„ÄÇÂÆûÈôÖÈÖçÁΩÆ‰ªé config/settings.yaml Âä†ËΩΩÔºå
Ê≠§Á§∫‰æã‰∏éÂΩìÂâçÈÄªËæë‰øùÊåÅÂêåÊ≠•ÔºåÊö¥Èú≤Âêë‰∏ãÂÖºÂÆπÁöÑÂ∏∏Èáè„ÄÇ
===============================================================================
"""

import os
import logging
import yaml
import csv
import functools
from datetime import datetime
from dotenv import load_dotenv

load_dotenv()

try:
    import colorlog
except Exception:
    colorlog = None

# ================= Ë∑ØÂæÑÈÖçÁΩÆ =================
PROJECT_ROOT = os.path.dirname(os.path.abspath(__file__))
LOG_DIR = os.path.join(PROJECT_ROOT, "logs")
DATA_DIR = os.path.join(PROJECT_ROOT, "data")
ARCHIVE_DIR = os.path.join(DATA_DIR, "archive")

# ================= ÈÖçÁΩÆÊñá‰ª∂Âä†ËΩΩ =================
def load_settings():
    settings_path = os.path.join(PROJECT_ROOT, "config", "settings.yaml")
    if not os.path.exists(settings_path):
        return {}
    with open(settings_path, "r", encoding="utf-8") as f:
        return yaml.safe_load(f)

SETTINGS = load_settings()

# Êö¥Èú≤ÈùôÊÄÅÈÖçÁΩÆÔºà‰øùÊåÅÂêë‰∏ãÂÖºÂÆπÔºâ
WATCHLIST = SETTINGS.get("watchlist", [])
TREND_SOURCES = SETTINGS.get("trend_sources", [])
OPERATIONAL_PHASE = SETTINGS.get("operational_phase", "VALUE_HACKER")
PHASE_CONFIG = SETTINGS.get("phase_config", {})
EFFICIENCY_KEYWORDS = SETTINGS.get("efficiency_keywords", [])
PAIN_KEYWORDS = SETTINGS.get("pain_keywords", [])
RADAR_QUERIES = SETTINGS.get("radar_queries", [])

_concurrency = SETTINGS.get("concurrency", {})
MAX_CONCURRENT_FETCHES = _concurrency.get("max_fetches", 5)
FETCH_TIMEOUT_SECONDS = _concurrency.get("fetch_timeout", 30)

# ================= ÊàêÊú¨ËøΩË∏™ =================
COST_LOG_FILE = os.path.join(DATA_DIR, "cost_log.csv")

def _init_cost_log():
    if not os.path.exists(COST_LOG_FILE):
        os.makedirs(os.path.dirname(COST_LOG_FILE), exist_ok=True)
        with open(COST_LOG_FILE, "w", encoding="utf-8", newline="") as f:
            csv.writer(f).writerow(
                ["Timestamp", "Model", "Input Tokens", "Output Tokens", "Cache Hit Tokens", "Estimated Cost ($)", "Function"]
            )

_init_cost_log()

# ================= API ÈÖçÁΩÆ =================
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY") or "sk-your-deepseek-api-key"
DEEPSEEK_BASE_URL = "https://api.deepseek.com"

EXA_API_KEY = os.getenv("EXA_API_KEY") or ""
TAVILY_API_KEY = os.getenv("TAVILY_API_KEY") or ""

SILICONFLOW_API_KEY = os.getenv("SILICONFLOW_API_KEY") or ""
SILICONFLOW_BASE_URL = "https://api.siliconflow.cn/v1"

# ================= ÁΩëÁªúÈÖçÁΩÆ =================
PROXY_URL = "http://127.0.0.1:7898"
REQUEST_TIMEOUT = 120

# ================= Êó•ÊúüÁõÆÂΩïÁÆ°ÁêÜ =================
WORKING_DATE = None

def set_working_date(date_str):
    """ËÆæÁΩÆÂ∑•‰ΩúÊó•ÊúüÔºåÊ†ºÂºè: YYYY-MM-DD Êàñ MMDD"""
    global WORKING_DATE
    if date_str:
        if len(date_str) == 4 and date_str.isdigit():
            year = datetime.now().year
            date_str = f"{year}-{date_str[:2]}-{date_str[2:]}"
        WORKING_DATE = date_str
        get_logger(__name__).info(f"üìÖ Â∑•‰ΩúÊó•ÊúüÂ∑≤ËÆæÁΩÆ‰∏∫: {WORKING_DATE}")

def get_working_date():
    return WORKING_DATE or datetime.now().strftime("%Y-%m-%d")

STAGE_DIRS = {
    "topics": "1_topics",
    "research": "2_research",
    "drafts": "3_drafts",
    "publish": "4_publish",
    "assets": "5_assets",
}

def get_today_dir():
    date_str = get_working_date()
    date_dir = os.path.join(ARCHIVE_DIR, date_str)
    os.makedirs(date_dir, exist_ok=True)
    return date_dir

def get_stage_dir(stage):
    stage_name = STAGE_DIRS.get(stage, stage)
    stage_dir = os.path.join(get_today_dir(), stage_name)
    os.makedirs(stage_dir, exist_ok=True)
    return stage_dir

def get_today_file(filename, stage=None):
    if stage:
        return os.path.join(get_stage_dir(stage), filename)
    return os.path.join(get_today_dir(), filename)

# ÂêÑÈò∂ÊÆµÊñá‰ª∂Ë∑ØÂæÑ
def get_topic_report_file():
    timestamp = datetime.now().strftime("%H%M")
    return get_today_file(f"report_{timestamp}.md", "topics")

def get_research_notes_file():
    return get_today_file("notes.txt", "research")

def get_draft_file():
    return get_today_file("draft.md", "drafts")

def get_todo_file():
    return get_today_file("todo_list.txt", "drafts")

def get_history_file():
    return os.path.join(DATA_DIR, "history.json")

def get_final_file():
    return get_today_file("final.md", "publish")

def get_html_file():
    return get_today_file("output.html", "publish")

def get_assets_dir():
    return get_stage_dir("assets")

# ================= ‰∫∫ËÆæÈÖçÁΩÆ =================
PERSONA_TAGS = [
    "AI", "‰∫∫Â∑•Êô∫ËÉΩ", "Â§ßÊ®°Âûã", "LLM", "DeepSeek", "Kimi", "ChatGPT", "Cursor",
    "ÊïàÁéá", "Â∑•ÂÖ∑", "Â∑•‰ΩúÊµÅ", "Ëá™Âä®Âåñ", "ÊèêÁ§∫ËØç", "Prompt", "Agent", "RAG"
]

# ================= Êó•ÂøóÈÖçÁΩÆ =================
def get_logger(name: str = "wx_articles") -> logging.Logger:
    log = logging.getLogger(name)
    if log.handlers:
        return log
    log.setLevel(logging.INFO)
    ch = logging.StreamHandler()
    ch._wx_articles_handler = True
    if colorlog is not None:
        ch.setFormatter(
            colorlog.ColoredFormatter(
                "%(log_color)s%(asctime)s %(levelname)s %(name)s: %(message)s",
                datefmt="%H:%M:%S",
                log_colors={
                    "DEBUG": "cyan",
                    "INFO": "green",
                    "WARNING": "yellow",
                    "ERROR": "red",
                    "CRITICAL": "bold_red",
                },
            )
        )
    else:
        ch.setFormatter(logging.Formatter("%(asctime)s %(levelname)s %(name)s: %(message)s"))
    log.addHandler(ch)
    return log

# ================= ÂàùÂßãÂåñ =================
def setup_proxy():
    if PROXY_URL:
        os.environ["HTTP_PROXY"] = PROXY_URL
        os.environ["HTTPS_PROXY"] = PROXY_URL
        os.environ["http_proxy"] = PROXY_URL
        os.environ["https_proxy"] = PROXY_URL

def ensure_dirs():
    os.makedirs(ARCHIVE_DIR, exist_ok=True)

setup_proxy()
ensure_dirs()
