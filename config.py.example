"""
===============================================================================
                    âš™ï¸ ç»Ÿä¸€é…ç½®æ–‡ä»¶ (config.py)
===============================================================================
æ‰€æœ‰æ™ºèƒ½ä½“å…±äº«çš„é…ç½®é¡¹ï¼Œä¿®æ”¹è¿™é‡Œå³å¯å…¨å±€ç”Ÿæ•ˆ

ä½¿ç”¨æ–¹æ³•ï¼š
1. å¤åˆ¶æ­¤æ–‡ä»¶ä¸º config.py
2. å¡«å…¥ä½ çš„çœŸå® API Key å’Œå¯†é’¥
3. config.py å·²è¢« .gitignore æ’é™¤ï¼Œä¸ä¼šè¢«æäº¤
===============================================================================
"""

import os
import logging
from datetime import datetime

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ================= API é…ç½® =================

# DeepSeek API Keyï¼ˆä¼˜å…ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY") or "sk-your-deepseek-api-key"

# DeepSeek API åœ°å€
DEEPSEEK_BASE_URL = "https://api.deepseek.com"

# ================= æœç´¢é…ç½® =================

# Exa AI (åŸ Metaphor) API Key
# https://dashboard.exa.ai/api-keys
EXA_API_KEY = os.getenv("EXA_API_KEY") or ""

# Tavily Search API (å¤‡ç”¨: https://tavily.com)
TAVILY_API_KEY = os.getenv("TAVILY_API_KEY") or ""

# ================= ç½‘ç»œé…ç½® =================

# ä»£ç†åœ°å€ï¼ˆå¦‚æœä¸éœ€è¦ä»£ç†ï¼Œè®¾ä¸º Noneï¼‰
PROXY_URL = "http://127.0.0.1:7898"

# è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
REQUEST_TIMEOUT = 120

# ================= å¾®ä¿¡å…¬ä¼—å·é…ç½® =================

# å¾®ä¿¡å…¬ä¼—å·é…ç½® (åœ¨å…¬ä¼—å·åå°-å¼€å‘-åŸºæœ¬é…ç½®ä¸­è·å–)
# æ”¯æŒç¯å¢ƒå˜é‡: WECHAT_APP_ID, WECHAT_APP_SECRET
# æ³¨æ„ï¼šä¸è¦å°†çœŸå®å¯†é’¥æäº¤åˆ°å…¬å¼€ä»“åº“ï¼
WECHAT_APP_ID = os.getenv("WECHAT_APP_ID") or "wx-your-app-id"
WECHAT_APP_SECRET = os.getenv("WECHAT_APP_SECRET") or "your-app-secret"

# ================= è·¯å¾„é…ç½® =================

# é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT = os.path.dirname(os.path.abspath(__file__))

# æ•°æ®ç›®å½•
DATA_DIR = os.path.join(PROJECT_ROOT, "data")
ARCHIVE_DIR = os.path.join(DATA_DIR, "archive")

# ================= æ—¥æœŸç›®å½•ç®¡ç† =================

# å·¥ä½œæ—¥æœŸï¼ˆé»˜è®¤ä»Šå¤©ï¼Œå¯é€šè¿‡ set_working_date() æŒ‡å®šï¼‰
WORKING_DATE = None

def set_working_date(date_str):
    """è®¾ç½®å·¥ä½œæ—¥æœŸï¼Œæ ¼å¼: YYYY-MM-DD æˆ– MMDD"""
    global WORKING_DATE
    if date_str:
        # æ”¯æŒ MMDD ç®€å†™æ ¼å¼
        if len(date_str) == 4 and date_str.isdigit():
            year = datetime.now().year
            date_str = f"{year}-{date_str[:2]}-{date_str[2:]}"
        WORKING_DATE = date_str
        logger.info("ğŸ“… å·¥ä½œæ—¥æœŸå·²è®¾ç½®ä¸º: %s", WORKING_DATE)

def get_working_date():
    """è·å–å½“å‰å·¥ä½œæ—¥æœŸ"""
    return WORKING_DATE or datetime.now().strftime("%Y-%m-%d")

# å·¥ä½œæµé˜¶æ®µç›®å½•ï¼ˆæ•°å­—å‰ç¼€ä¿è¯æ’åºï¼‰
STAGE_DIRS = {
    "topics": "1_topics",      # é€‰é¢˜æŠ¥å‘Š
    "research": "2_research",  # è°ƒç ”ç¬”è®°
    "drafts": "3_drafts",      # è‰ç¨¿
    "publish": "4_publish",    # å‘å¸ƒæ–‡ä»¶
    "assets": "5_assets",      # èµ„æºæ–‡ä»¶ï¼ˆå›¾ç‰‡ç­‰ï¼‰
}

def get_today_dir():
    """è·å–å·¥ä½œæ—¥æœŸçš„å½’æ¡£ç›®å½•ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º"""
    date_str = get_working_date()
    date_dir = os.path.join(ARCHIVE_DIR, date_str)
    os.makedirs(date_dir, exist_ok=True)
    return date_dir

def get_stage_dir(stage):
    """è·å–ä»Šå¤©æŸä¸ªé˜¶æ®µçš„ç›®å½•"""
    stage_name = STAGE_DIRS.get(stage, stage)
    stage_dir = os.path.join(get_today_dir(), stage_name)
    os.makedirs(stage_dir, exist_ok=True)
    return stage_dir

def get_today_file(filename, stage=None):
    """è·å–ä»Šå¤©å½’æ¡£ç›®å½•ä¸‹çš„æ–‡ä»¶è·¯å¾„ï¼Œå¯æŒ‡å®šé˜¶æ®µ"""
    if stage:
        return os.path.join(get_stage_dir(stage), filename)
    return os.path.join(get_today_dir(), filename)

# ================= å„é˜¶æ®µæ–‡ä»¶è·¯å¾„ =================

def get_topic_report_file():
    """é€‰é¢˜æŠ¥å‘Š"""
    timestamp = datetime.now().strftime("%H%M")
    return get_today_file(f"report_{timestamp}.md", "topics")

def get_research_notes_file():
    """ç ”ç©¶ç¬”è®°ï¼ˆç›´æ¥åœ¨æ—¥æœŸç›®å½•ä¸‹ç¼–è¾‘ï¼‰"""
    return get_today_file("notes.txt", "research")

def get_draft_file():
    """è‰ç¨¿"""
    return get_today_file("draft.md", "drafts")

def get_todo_file():
    """TODO æ¸…å•"""
    return get_today_file("todo_list.txt", "drafts")

def get_history_file():
    """å†å²é€‰é¢˜è®°å½•"""
    return os.path.join(DATA_DIR, "history.json")

def get_final_file():
    """å®šç¨¿"""
    return get_today_file("final.md", "publish")

def get_html_file():
    """HTML è¾“å‡º"""
    return get_today_file("output.html", "publish")

def get_assets_dir():
    """èµ„æºç›®å½•ï¼ˆå›¾ç‰‡ç­‰ï¼‰"""
    return get_stage_dir("assets")


# ================= äººè®¾é…ç½® =================

# åšä¸»äººè®¾æ ‡ç­¾ï¼ˆç”¨äºé€‰é¢˜è¿‡æ»¤ï¼‰
PERSONA_TAGS = [
    "AI", "äººå·¥æ™ºèƒ½", "å¤§æ¨¡å‹", "LLM", "DeepSeek", "Kimi", "ChatGPT", "Cursor",
    "æ•ˆç‡", "å·¥å…·", "å·¥ä½œæµ", "è‡ªåŠ¨åŒ–", "æç¤ºè¯", "Prompt", "Agent", "RAG"
]

# ================= åˆå§‹åŒ– =================

def setup_proxy():
    """è®¾ç½®ä»£ç†ç¯å¢ƒå˜é‡"""
    if PROXY_URL:
        os.environ['HTTP_PROXY'] = PROXY_URL
        os.environ['HTTPS_PROXY'] = PROXY_URL
        os.environ['http_proxy'] = PROXY_URL
        os.environ['https_proxy'] = PROXY_URL

def ensure_dirs():
    """ç¡®ä¿å¿…è¦çš„ç›®å½•å­˜åœ¨"""
    os.makedirs(ARCHIVE_DIR, exist_ok=True)

# è‡ªåŠ¨åˆå§‹åŒ–
setup_proxy()
ensure_dirs()
