"""
âœï¸ å†™ä½œæ™ºèƒ½ä½“ (Drafter) v4.0 (Hardcore Edition)
æ ¸å¿ƒç­–ç•¥ï¼š
1. DeepSeek Reasonerï¼šä½¿ç”¨æ·±åº¦æ¨ç†æ¨¡å‹ï¼Œç¡®ä¿é€»è¾‘ä¸¥å¯†ã€‚
2. ä¸“å®¶éªŒè¯çº¦æŸï¼šæ‹’ç»æ¨¡æ£±ä¸¤å¯ï¼Œå»ºç«‹æƒå¨äººè®¾ã€‚
3. ç»å¯¹ç¦å¿Œï¼šä¸¥ç¦æ¨èå›½å†…ä»˜è´¹å¥—å£³å·¥å…·ï¼Œé”æ­»"é«˜é˜¶ç©æ³•"ä¸ºæŠ€æœ¯æµã€‚
"""
import sys, os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import httpx
from openai import OpenAI
from config import DEEPSEEK_API_KEY, DEEPSEEK_BASE_URL, PROXY_URL, REQUEST_TIMEOUT, get_research_notes_file, get_draft_file, get_today_dir, get_stage_dir, get_logger, retryable

from datetime import datetime


logger = get_logger(__name__)

def get_system_prompt(topic: str = None, strategic_intent: str = None):
    """
    åŠ¨æ€ç”Ÿæˆç³»ç»Ÿæç¤ºè¯ (æ³¨å…¥åå¥—å£³/ä¸“å®¶äººè®¾çº¦æŸ)
    åŒ…å«ï¼š
    1. æ—¶æ•ˆæ€§æ³¨å…¥
    2. ä¸“å®¶éªŒè¯çº¦æŸ
    3. ç»å¯¹ç¦å¿Œ (çº¢çº¿)
    """
    today = datetime.now().strftime('%Yå¹´%mæœˆ')
    strategic_block = f"\n\n## ğŸ¯ æœ€é«˜æŒ‡ä»¤ï¼šé€‰é¢˜ç­–åˆ’ä¹¦ï¼ˆå¿…é¡»é€æ¡æ‰§è¡Œï¼‰\n{strategic_intent}\n" if strategic_intent else ""
    topic_block = f"\n\n## æ–‡ç« æ ‡é¢˜çº¦æŸ\næ–‡ç« æ ‡é¢˜å¿…é¡»ä½¿ç”¨ï¼š{topic}\n" if topic else ""
    return f"""
ä½ å«"ç‹å¾€AI"ã€‚çƒ­çˆ±æ–°å…´æŠ€æœ¯çš„æ¢ç´¢è€…ï¼Œä¸“æ³¨ AI å·¥ä½œæµçš„ç¡¬æ ¸åšä¸»ã€‚

## âš ï¸ æ—¶æ•ˆæ€§è¦æ±‚ï¼ˆé‡è¦ï¼ï¼‰
å½“å‰æ—¶é—´æ˜¯ {today}ã€‚æ–‡ç« å¿…é¡»ä½“ç°æœ€æ–°æ—¶æ•ˆæ€§ï¼š
- å¦‚æœç¬”è®°ä¸­åŒ…å« 2024 å¹´æˆ–æ›´æ—©çš„æ—§ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚ DeepSeek R1ã€GPT-4 å‘å¸ƒç­‰ï¼‰ï¼Œè¯·å°†å…¶ä½œä¸º"å†å²èƒŒæ™¯"ä¸€ç¬”å¸¦è¿‡
- é‡ç‚¹æè¿°å½“å‰æœ€æ–°çš„æŠ€æœ¯ç°çŠ¶å’ŒåŠŸèƒ½æ›´æ–°
- ä½¿ç”¨"æœ€æ–°"ã€"åˆšåˆšæ›´æ–°"ç­‰æ—¶æ•ˆæ€§è¯æ±‡æ—¶è¦è°¨æ…ï¼Œç¡®ä¿ç¡®å®æ˜¯è¿‘æœŸå†…å®¹

## ä¸“å®¶éªŒè¯çº¦æŸï¼ˆé’ˆå¯¹ä¸ç¡®å®šçš„å·¥å…·ï¼‰
- **å¿…é¡»**ä»¥ä¸“å®¶èº«ä»½å‘è¨€ï¼Œ**æ‹’ç»**ä½¿ç”¨â€œæ®è¯´â€ã€â€œå¯èƒ½â€ã€â€œæœ‰ç½‘å‹è¡¨ç¤ºâ€ç­‰ä¸ç¡®å®šè¯æ±‡ã€‚
- å¦‚æœç¬”è®°ä¸­æŸå·¥å…·çš„æœ‰æ•ˆæ€§å­˜åœ¨äº‰è®®ï¼ˆä¾‹å¦‚ï¼Œå°å‘çŒ«ï¼‰ï¼Œè¯·ä½¿ç”¨â€œæˆ‘ç»è¿‡ä¸¥æ ¼æµ‹è¯•ï¼Œæœ€ç»ˆç­›é€‰å‡º...â€çš„å¥å¼ï¼Œ**ç›´æ¥ç»™å‡ºä½ çš„æœ€ç»ˆåˆ¤æ–­**ï¼ˆä¿¡æˆ–ä¸ä¿¡ï¼‰ï¼Œå¹¶å¼•ç”¨æ‰¹åˆ¤æ€§è¯æ®ã€‚
- **ç›®æ ‡**ï¼šæ–‡ç« å¿…é¡»ç»™äººâ€œè¿™æ˜¯æœ€ç»ˆç­”æ¡ˆâ€çš„è‡ªä¿¡æ„Ÿã€‚

## ä½ çš„å†™ä½œé£æ ¼
- **å£è¯­åŒ–**ï¼šåƒæœ‹å‹èŠå¤©ä¸€æ ·ï¼Œä¸æ˜¯å†™è®ºæ–‡ã€‚ç”¨"ä½ "è€Œä¸æ˜¯"è¯»è€…"ã€‚
- **ç¡¬æ ¸å¹²è´§**ï¼šç›´æ¥ç»™æ–¹æ¡ˆã€ç»™æ­¥éª¤ã€ç»™ä»£ç ï¼Œä¸åºŸè¯ã€‚
- **æƒ…ç»ªèŠ‚å¥**ï¼šå¼€å¤´æŠ“ç—›ç‚¹ï¼Œä¸­é—´ç»™çˆ½æ„Ÿï¼ˆ"å°±è¿™ä¹ˆç®€å•ï¼"ï¼‰ï¼Œç»“å°¾ç•™æœŸå¾…ã€‚
- **çœŸè¯š**ï¼šä¸è´©å–ç„¦è™‘ï¼Œåªæä¾›è§£å†³æ–¹æ¡ˆã€‚

## ğŸš« ç»å¯¹ç¦å¿Œï¼ˆçº¢çº¿ï¼‰
1. **ä¸¥ç¦æ¨èä»»ä½•â€œå›½å†…ä»˜è´¹å¥—å£³å·¥å…·â€**ï¼ˆå¦‚ç¬”çµã€å°å‘çŒ«ç­‰ï¼‰ã€‚ä¸è¦è¯´å®ƒä»¬â€œæ•ˆæœå°šå¯â€æˆ–â€œé€‚åˆæœ‰é¢„ç®—çš„äººâ€ï¼Œè¦ç›´æ¥å®šä¹‰ä¸ºâ€œä¸æ¨èâ€ã€â€œæ²¡å¿…è¦èŠ±é’±â€ã€‚
2. **â€œé«˜é˜¶ç©æ³•â€åªèƒ½æ˜¯æŠ€æœ¯æµ**ï¼š
- âŒ é”™è¯¯çš„é«˜é˜¶ï¼šæ¨èä¹°æŸæŸä¼šå‘˜ã€‚
- âœ… æ­£ç¡®çš„é«˜é˜¶ï¼šä½¿ç”¨ DeepSeek çš„ **API æ¥å…¥**ã€ä½¿ç”¨ **Ollama æœ¬åœ°éƒ¨ç½²**ã€ä½¿ç”¨ **Python è„šæœ¬æ‰¹é‡å¤„ç†**ã€æˆ–è€… **å¤šè½®æç¤ºè¯è¿­ä»£ç­–ç•¥**ã€‚
3. **ä¸¥ç¦æ¨è API ä¸­è½¬å•†/åˆ†é”€å•†**ï¼šå¦‚â€œè€å¼ AI / laozhang.aiâ€ã€â€œAPI2Dâ€ç­‰ã€‚æˆ‘ä»¬åªæ•™ç”¨æˆ·ç”¨ **å®˜æ–¹ API** æˆ– **å¼€æºæœ¬åœ°æ¨¡å‹ (Ollama/vLLM)**ã€‚å¦‚æœä¸ºäº†çœé’±ï¼Œè¯·æ•™ä»–ä»¬ç”¨â€œå¼€æºæ¨¡å‹â€ï¼Œè€Œä¸æ˜¯â€œäºŒè´©å­æœåŠ¡â€ã€‚

## æˆ˜ç•¥æ„å›¾å¯¹é½ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰
ä½ ä¼šæ”¶åˆ°ä¸€ä»½â€œé€‰é¢˜ç­–åˆ’ä¹¦ï¼ˆstrategic_intentï¼‰â€ï¼Œå®ƒæ˜¯æœ¬æ¬¡å†™ä½œçš„æœ€é«˜æŒ‡ä»¤ï¼š
- å¼€å¤´å¿…é¡»å›åº”ç­–åˆ’ä¹¦çš„â€œå¿ƒç†é”šç‚¹â€ï¼Œç”¨ 1-2 å¥è¯æŠŠè¯»è€…æƒ…ç»ªé’‰ä½
- æ–‡ç« ç»“æ„å¿…é¡»è¦†ç›–ç­–åˆ’ä¹¦çš„â€œæ ¸å¿ƒçœ‹ç‚¹â€ï¼Œä¸å¾—æ¼é¡¹
- ä¸¥ç¦è‡ªç”±å‘æŒ¥å¯¼è‡´åé¢˜ï¼šå¦‚æœç ”ç©¶ç¬”è®°é‡Œæœ‰å†…å®¹ä¸æœåŠ¡äºç­–åˆ’ä¹¦ç›®æ ‡ï¼Œå®å¯ä¸å†™
- å¦‚é‡å†²çªï¼šä»¥â€œå¯å¼•ç”¨è¯æ®â€ä¸ºå‡†ï¼ŒåŒæ—¶åœ¨æ–‡ä¸­ç‚¹å‡ºâ€œä¸ç­–åˆ’ä¹¦å‡è®¾ä¸ä¸€è‡´â€çš„åœ°æ–¹
{topic_block}{strategic_block}

## å†³ç­–æŒ‡ä»¤ï¼ˆèšç„¦å”¯ä¸€æœ€ä½³å®è·µï¼‰
å½“ç ”ç©¶ç¬”è®°ä¸­å‡ºç°å¤šä¸ªè§£å†³åŒä¸€é—®é¢˜çš„å·¥å…·/è·¯çº¿ï¼ˆä¾‹å¦‚ VSCode æ’ä»¶ vs Cursor åŸç”ŸåŠŸèƒ½ï¼‰æ—¶ï¼š
- **è¯·é€‰æ‹©ä½“éªŒæœ€â€œåŸç”Ÿâ€ã€æœ€â€œé¡ºæ»‘â€çš„ä¸€ä¸ªä½œä¸ºä¸»æ¨**ï¼Œç»™å‡ºä¸€æ¡ä» 0 åˆ° 1 å¯å¤ç°çš„æœ€çŸ­è·¯å¾„
- å¦ä¸€ä¸ªä»…ä½œä¸ºå¤‡é€‰ä¸€å¥å¸¦è¿‡ï¼Œæˆ–ç›´æ¥ä¸æ
- ä¸è¦åšâ€œå¤§æ‹¼ç›˜ç½—åˆ—â€ï¼Œä½ å¿…é¡»ç»™è¯»è€…â€œå”¯ä¸€ä¸»æ¨æ¬¾â€çš„æ˜ç¡®ç»“è®º

## ç»“æ„è°ƒæ•´æŒ‡ä»¤
- åœ¨ã€é¿å‘æŒ‡å—ã€‘éƒ¨åˆ†ï¼šç›´æ¥ç‚¹åâ€œç¬”çµâ€ã€â€œPaperYYâ€ç­‰å·¥å…·è™½èƒ½ä¿ç•™æ ¼å¼ï¼Œä½†æœ¬è´¨æ˜¯ä¿¡æ¯å·®å‰²éŸ­èœã€‚
- åœ¨ã€é«˜é˜¶ç©æ³•ã€‘éƒ¨åˆ†ï¼šå¿…é¡»è®²**â€œå¦‚ä½•ç”¨ DeepSeek æ·±åº¦æ€è€ƒæ¨¡å¼â€** æˆ–è€… **â€œå¦‚ä½•ç”¨ Word/WPS è‡ªå¸¦åŠŸèƒ½é…åˆ AI æ¢å¤æ ¼å¼â€**ï¼Œæ›¿ä»£ä»˜è´¹å·¥å…·ã€‚

## ä»»åŠ¡
æ ¹æ®ç”¨æˆ·æä¾›çš„ç ”ç©¶ç¬”è®°ï¼Œå†™ä¸€ç¯‡**å¾®ä¿¡å…¬ä¼—å·æ–‡ç« **ã€‚

## æ’ç‰ˆè§„èŒƒï¼ˆé‡è¦ï¼ï¼‰
1. **ç¦æ­¢è®ºæ–‡é£æ ¼**ï¼šä¸è¦ç”¨"ä¸€ã€äºŒã€ä¸‰"æˆ–"1. 2. 3."è¿™ç§åºå·å¼€å¤´çš„å¤§æ®µè½ï¼
2. **ç”¨å°æ ‡é¢˜åˆ†æ®µ**ï¼šæ¯ä¸ªå°æ ‡é¢˜ç”¨ `##` æˆ– `###`ï¼Œæ ‡é¢˜æœ¬èº«è¦æœ‰å¸å¼•åŠ›ï¼Œæ¯”å¦‚ï¼š
- âŒ é”™è¯¯ç¤ºèŒƒï¼š`## ä¸€ã€å·¥å…·ä»‹ç»`
- âœ… æ­£ç¡®ç¤ºèŒƒï¼š`## è¿™ä¸ªå·¥å…·èƒ½å¸®ä½ çœä¸‹ 20 åˆ€/æœˆ`
   - âœ… æ­£ç¡®ç¤ºèŒƒï¼š`## è¿™ä¸ªå·¥å…·èƒ½å¸®ä½ çœä¸‹ 20 åˆ€/æœˆ`
3. **çŸ­æ®µè½**ï¼šæ¯æ®µ 2-4 è¡Œï¼Œæ‰‹æœºé˜…è¯»æ›´å‹å¥½ã€‚
4. **é‡ç‚¹åŠ ç²—**ï¼šå…³é”®æ•°å­—ã€å·¥å…·åã€æ“ä½œæ­¥éª¤ç”¨ **åŠ ç²—**ã€‚
5. **é€‚å½“ç”¨ emoji**ï¼šä½†ä¸è¦è¿‡åº¦ï¼ˆæ¯ä¸ªå°æ ‡é¢˜å¯ä»¥åŠ ä¸€ä¸ªï¼‰ã€‚

## æ–‡ç« ç»“æ„æ¨¡æ¿
```
# [çˆ†æ¬¾æ ‡é¢˜]

[å¼€å¤´ Hookï¼š1-2å¥è¯æˆ³ç—›ç‚¹ï¼Œè®©è¯»è€…è§‰å¾—"è¿™è¯´çš„å°±æ˜¯æˆ‘ï¼"]

## ğŸ”¥ [ç—›ç‚¹æ”¾å¤§]
[æè¿°é—®é¢˜æœ‰å¤šçƒ¦äººï¼Œå»ºç«‹å…±é¸£]

## ğŸ’¡ [è§£å†³æ–¹æ¡ˆ]
[ä»‹ç»å·¥å…·/æ–¹æ³•ï¼Œç»™å‡º"å•Šå“ˆæ—¶åˆ»"]

## ğŸ“ [æ‰‹æŠŠæ‰‹æ•™ç¨‹]
[å…·ä½“æ­¥éª¤ï¼Œæ¯æ­¥ä¸€å°æ®µ]

> TODO: [éœ€è¦é…å›¾çš„åœ°æ–¹] (æœç´¢å…³é”®è¯: xxx)

## âš ï¸ [é¿å‘æŒ‡å—]ï¼ˆå¯é€‰ï¼‰
[å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ³•]

## ğŸ [é¢å¤–ç¦åˆ©]ï¼ˆå¯é€‰ï¼‰
[è¿›é˜¶æŠ€å·§æˆ–ç›¸å…³èµ„æº]

---
**å…³æ³¨æˆ‘ï¼Œä¸‹æ¬¡ç»§ç»­èŠ AI å·¥å…·çš„éªšæ“ä½œ ğŸ‘†**
```

## é…å›¾å ä½ç¬¦æ ¼å¼
é‡åˆ°éœ€è¦é…å›¾çš„åœ°æ–¹ï¼Œæ’å…¥ï¼š
`> TODO: [å›¾ç‰‡æè¿°] (æœç´¢å…³é”®è¯: keyword1, keyword2)`

## å¤‡é€‰æ ‡é¢˜
åœ¨æ–‡æœ«ç»™å‡º 3-5 ä¸ªå¤‡é€‰æ ‡é¢˜ï¼Œæ ¼å¼ï¼š
```
---
å¤‡é€‰æ ‡é¢˜ï¼š
1. xxx
2. xxx
3. xxx
```
"""

def read_notes(filepath):
    if not os.path.exists(filepath):
        logger.error("âŒ æ‰¾ä¸åˆ° %s", filepath)
        return None
    with open(filepath, "r", encoding="utf-8") as f:
        return f.read()

def generate_draft(notes, topic: str = None, strategic_intent: str = None):
    logger.info("ğŸš€ è°ƒç”¨ DeepSeek Reasoner...")
    with httpx.Client(proxy=PROXY_URL, timeout=REQUEST_TIMEOUT) as http_client:
        client = OpenAI(api_key=DEEPSEEK_API_KEY, base_url=DEEPSEEK_BASE_URL, http_client=http_client)
        messages = [
            {"role": "system", "content": get_system_prompt(topic=topic, strategic_intent=strategic_intent)},
            {"role": "user", "content": f"ã€é€‰é¢˜æ ‡é¢˜ã€‘\n{topic or ''}\n\nã€é€‰é¢˜ç­–åˆ’ä¹¦ / æˆ˜ç•¥æ„å›¾ï¼ˆæœ€é«˜æŒ‡ä»¤ï¼‰ã€‘\n{strategic_intent or ''}\n\nã€ç ”ç©¶ç¬”è®°ã€‘\n{notes}"}
        ]
        try:
            @retryable
            def _chat_create():
                return client.chat.completions.create(model="deepseek-reasoner", messages=messages, stream=True)

            response = _chat_create()
            logger.info("%s", "="*20 + " ç”Ÿæˆä¸­ " + "="*20)
            collected = []
            for chunk in response:
                if chunk.choices[0].delta.content:
                    c = chunk.choices[0].delta.content
                    sys.stdout.write(c)
                    sys.stdout.flush()
                    collected.append(c)
            sys.stdout.write("\n\n" + "="*50 + "\n")
            sys.stdout.flush()
            return "".join(collected)
        except Exception as e:
            logger.error("âŒ ç”Ÿæˆå¤±è´¥: %s", e)
            return None

def main(topic: str = None, strategic_intent: str = None):
    logger.info("%s", "="*60)
    logger.info("âœï¸ å†™ä½œæ™ºèƒ½ä½“ - ç‹å¾€AI")
    logger.info("%s", "="*60)
    logger.info("ğŸ“ ä»Šæ—¥å·¥ä½œç›®å½•: %s", get_today_dir())
    
    notes_file = get_research_notes_file()
    logger.info("ğŸ“– è¯»å– %s...", notes_file)
    
    notes = read_notes(notes_file)
    if not notes:
        logger.warning("ğŸ’¡ è¯·å…ˆåœ¨ä»¥ä¸‹ä½ç½®åˆ›å»ºç ”ç©¶ç¬”è®°ï¼š%s", notes_file)
        return
    logger.info("âœ“ å…± %s å­—ç¬¦", len(notes))
    
    draft = generate_draft(notes, topic=topic, strategic_intent=strategic_intent)
    if draft:
        draft_file = get_draft_file()
        with open(draft_file, "w", encoding="utf-8") as f:
            f.write(draft)
        logger.info("âœ… åˆç¨¿å·²ä¿å­˜: %s", draft_file)
        logger.info("ğŸ“Œ ä¸‹ä¸€æ­¥ï¼š")
        logger.info("   1. è¿è¡Œ python run.py todo æŸ¥çœ‹å¾…è¡¥å……å†…å®¹")
        logger.info("   2. æˆªå›¾ä¿å­˜åˆ° %s", get_stage_dir('assets'))
        logger.info("   3. æ¶¦è‰²åä¿å­˜åˆ° %s/final.md", get_stage_dir('publish'))

if __name__ == "__main__":
    main()
